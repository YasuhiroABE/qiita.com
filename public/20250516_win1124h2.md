---
title: 仮想マシンのパフォーマンスが悪化したので調べてみた
tags:
  - Ubuntu
  - vmware
private: false
updated_at: '2025-05-16T13:38:17+09:00'
id: bc0e5f82a677d65349fb
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに

Windows11 24H2はあまり評判が良くないようですが、これまでも単純なUIの変更に対して辛辣な意見が表明されるなど、Windowsユーザーの多くからは"変更"そのものに建設的ではないネガティブな意見が散見されてきた印象です。

とはいえ今回はカーネルのバージョンそのものが変更されているのでドライバ周りで深刻な影響を受けることもあるでしょうし、機能が増えることでこれまでのハードウェアでは資源が不足する状況も想定されます。

たまたまWindows11の24H2にしたタイミングでVM上のUbuntuのパフォーマンス低下が気になるようにしたので、調べた結果をまとめてみました。

という書き出しでオリジナルのタイトルにはWindows11の文字も入れて、24H2が悪いという論調だったのですが、結論は関係がなかったということで修正しています。

さて、私は日常的にThinkPad T14 Gen2 (CPU: i7-1165G7, Memory: 48GB) + j5 JTD568 Thunderbolt4 ドックの組み合せで、電源を供給しながらWindows11をメインの作業用に利用しています。

データ処理やプログラミングなどはVMware Workstation Pro上のUbuntuを利用していて、このVMを引っ越せば業務は継続できるようにしています。

# 現象

VM上のUbuntuで日本語の入力などをしていると、キーボードをタイプしてから入力までに数秒の遅延が発生するようになりました。

また静電容量無接点タイプなのにVM上ではチャタリングが発生していて、実用上問題だと感じる状態になっています。

レスポンスの悪化はVMware Workstationの自動スナップショットなどの機能を利用していると発生する可能性はあると思います。

また全体のパフォーマンスについてはIntel CPU 12世代以降からのP-coreがちゃんと使われないといった問題があって以前から公式フォーラムなどでも話題になっていましたが、徳丸さんのつぶやきでpowercfgで全コア利用する方法が知られるようになってきました。

https://forest.watch.impress.co.jp/docs/serial/yajiuma/2010063.html

VMwareのフォーラムではP-coreだけ有効にするといった提案もあったと思いますが、全コア有効で改善するようです。

今回はいずれの機能も利用していないので、Windows11の電源管理やセキュリティ周りを中心に設定変更でできることがないか調べてみました。

# 結論

試したことはここから後ろのパートに書いていますが、最終的にCPUの割り当て数を実コアを越えないように変更しました。

Core i7-1165G7は4コア、8スレッドが実効可能ですが、最近1ソケット**2コア**から1ソケット**4コア**に割り当てを変更していたことを失念していて、これが原因でした。

これを**3コア**に減らしたところ劇的にレスポンスが改善して、快適にVMが利用できるようになっています。

メモリについてもやや不足気味だったので、8GBに一応変更していますが、これは6GBに戻しても問題なく直接パフォーマンスには影響しませんでした。

確認のためメモリ8GBの状態でコア数を実コアと同じ**4コア**にしたところ、レスポンスが劇的に悪化する現象が再発しました。

:::note
結論：VMのパフォーマンスはセキュリティよりもコア数の割り当て(**実コア数未満!!**)をまず確認しましょう。
:::

# パフォーマンス・チューニングの試み

ホストOSと仮想環境側の両方の設定をみていきます。

今回はゲストOSに変更はないので、まずは何も変更せずにこの記事を作成しながらパフォーマンスが改善するように変更していきます。

## バックグラウンドプロセス

ホストOS側でバックアップを取得していたりすると、その間はパフォーマンスの低下が発生する可能性があります。

基本的に毎朝早朝にバックアップ取得は完了しているので、CPUやメモリ、ディスクやネットワークへのアクセス状況に問題がないことを確認しています。

## 電源管理

23H2ではコントロールパネルの電源管理設定は「バランス」設定で問題なかったのですが、今回は「最適なパフォーマンス」に変更します。

ThinkPadではインテリジェントクーリングという機能はありますが、これは自動にしています。

またBIOS(UEFI)の設定で電源接続時は最大パフォーマンスになるよう設定しています。

https://www.itmedia.co.jp/pcuser/articles/2208/09/news115_2.html

インテリジェントクーリングはOFFの方が良いのではという意見もあるので、様子をみながら調整していきます。

## デバイスの放熱

ThinkPadのシステム・ファンはしばらく前に新品に交換しています。

さらに底面に12cmファンを敷いているので、放熱については配慮した状態にはなっています。

## セキュリティ関連

WindowsOSにもVMware Workstation自体にもいくつかパフォーマンスに影響を与える設定項目があります。

### VMware Workstationのグルーバル設定

環境設定の優先順位の設定を確認しておきます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/a0e4f67c-f176-46f2-a592-fa9e236d6cec.png)

### VMWare Workstationのサイドチャネル攻撃への対処

VM毎に設定できる項目で、チェックを外さずに有効化している状態になっています。

### Windowsセキュリティ

デバイス・セキュリティについては、コア分離が無効化されていると表示されています。

この画面は後述するグループポリシーで無効を定義した場合のものです。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/16483933-3431-45ff-a569-efca45c81088.png)

未定義にしてから可能な項目は全て有効にしています。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/69a03703-0517-4479-861e-de3660a49571.png)

### VBS(仮想化ベースのセキュリティ)

無効化したいのですが、WSL2を利用していたりするのでHyper-Vの利用は止められないかなという状況です。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/6dddef0d-6727-4ea4-b510-4ff83217219e.png)

おそらくこれを無効にすれば問題は解決するんじゃないかと思うのですが、とりあえず他の対策を検討します。

### グループポリシーの設定

ここは無効化していましたが、現在は未構成に変更しています。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/0eff7685-add0-4057-a6c7-04f6082ed198.png)

無効でもHyper-Vが起動するとVBSは有効化されていましたが、前述したように中途半端な設定だったので有効化しています。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/2677dc76-c700-482e-8150-9619bf206636.png)

## その他のシステムの設定

UEFIとBIOSの選択ではベアメタルであればfwupdmgrコマンドを利用するためにUEFIにするべきだと思いますが、仮想マシンであればどちらでも大きな問題はないように思えます。

この点は議論のポイントになることがあって、例えばProxmoxではfwupdだけでなく、ZFSを使うならUEFIでしょうという意見もあったりします。

https://forum.proxmox.com/threads/benefits-of-using-uefi-intallation-for-prox-instead-of-bios.97944/

VMware Workstation Proのような利用だとあまり関係なさそうです。

オーバヘッドもなさそうなので、デフォルトのままBIOSでUbuntuは動作させようと思います。

変更しようとするとESP領域の確保など起動ディスクは作り替え(入れ替え)が必要になるため、安易に変更できないことも理由ではあります。

# 現状のVMパフォーマンス

これまではむしろパフォーマンスを悪化させる方向に構成を変更してきましたが、できるだけ最小の手順で改善を目指します。

## VMの優先順位でフォアグラウンドを高に変更する

グローバル設定ではフォアグラウンドもバックグラウンドも標準設定だったので、問題になっているVMの個別設定でフォアグラウンドの優先順位を*高*に変更してみます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/a50d558d-1ce6-4c94-ad48-b16e16fbf7bf.png)

### 変更後のレスポンス

体感としては大きく変わっていませんが、チャタリングの発生頻度はわずかには改善されているかもしれません。

まだ遅延が発生していて、少なくともタイピングゲームを安定的に遊べるような状況ではありません。

この設定が他に影響しないのであれば、**高**のままにしておきます。

## サイドチャネルの攻撃への緩和を無効化する

公式がパフォーマンスに影響するけど設定を推奨する項目です。

無効化して様子を確認します。

### 変更後のレスポンス#2

変化がまったく分からない状況です。

この程度であればサイドチャネル攻撃への緩和処置は有効にして利用しようかなと思います。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/78296/e276a431-983c-4b81-84cc-15e8bb98ee8b.png)

# 次の変更案

セキュリティ設定が影響するように考えてきましたが、これらの項目は体感としてはそれほど大きな影響はありませんでした。

次にホストOSとゲストOSとの通信が影響している可能性を考慮して他の設定を確認していきます。

## ディスプレイの3Dアクセラレーションを無効にする

この設定項目はLinuxでは無効化するべきだった期間が長かったように感じます。

現在では問題なくデフォルトで有効化されている項目です。

結論からいうとこの項目はレスポンスに影響を与えなかったため、現在は十分なメモリを割り当てた上で有効にしています。

## メモリとコア数の割り当てを確認する

ここで冒頭の結論に到達しました。

# まとめ

冒頭にまとめたとおり、CPUのコア数割り当てが原因でした。

検索すると時々ヒットするセキュリティ関連の設定無効化はどれも関係ありませんでした。

今回はついでにホストOSのセキュリティ設定も改善できたので良かったのかなと思います。

